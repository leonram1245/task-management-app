- name: 📤 Upload backend code to EC2 via rsync
  run: |
    echo "🔐 Writing EC2 SSH private key to ~/.ssh/id_rsa..."
    mkdir -p ~/.ssh
    echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa
    echo "✅ SSH key written."

    echo "📍 Current working directory:"
    pwd

    echo "📂 Listing files in root:"
    ls -al

    echo "📂 Changing into ./backend directory..."
    cd backend || { echo "❌ backend directory not found"; exit 1; }

    echo "📍 Now in directory:"
    pwd

    echo "📂 Listing backend directory contents:"
    ls -al

    echo "📡 Running rsync to EC2..."
    rsync -avz --exclude 'node_modules' --exclude '.git' --exclude '.env' \
      -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" \
      . ubuntu@${{ secrets.EC2_HOST }}:~/app || { echo "❌ rsync failed"; exit 1; }

    echo "✅ rsync upload complete."
